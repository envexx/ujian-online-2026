// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String
  role         UserRole
  profilePhoto String?  // URL to profile photo
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  siswa Siswa?
  guru  Guru?

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@map("users")
}

enum UserRole {
  ADMIN
  GURU
  SISWA
}

// ============================================
// SCHOOL INFORMATION
// ============================================

model SekolahInfo {
  id        String   @id @default(cuid())
  
  // Informasi Sekolah
  namaSekolah    String
  alamat         String
  noTelp         String
  email          String
  website        String?
  logo           String?  // URL to logo file
  
  // Kepala Sekolah
  namaKepsek     String
  nipKepsek      String
  
  // Tahun Ajaran
  tahunAjaran    String   // 2024/2025
  semester       String   // Ganjil/Genap
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@map("sekolah_info")
}

// ============================================
// MASTER DATA
// ============================================

model Kelas {
  id          String   @id @default(cuid())
  nama        String   @unique // 7A, 7B, 8A, etc
  tingkat     String // 7, 8, 9
  waliKelasId String?
  tahunAjaran String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  waliKelas Guru?    @relation("WaliKelas", fields: [waliKelasId], references: [id])
  siswa     Siswa[]
  guru      GuruKelas[]
  jadwal    Jadwal[]

  @@index([nama])
  @@index([tingkat])
  @@index([tahunAjaran])
  @@map("kelas")
}

model MataPelajaran {
  id        String   @id @default(cuid())
  nama      String   @unique
  kode      String   @unique
  jenis     String // wajib, peminatan
  jamPerMinggu Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  guru    GuruMapel[]
  jadwal  Jadwal[]
  materi  Materi[]
  ujian   Ujian[]
  tugas   Tugas[]

  @@map("mata_pelajaran")
}

// ============================================
// GURU
// ============================================

model Guru {
  id           String   @id @default(cuid())
  userId       String   @unique
  nipUsername  String   @unique // NIP atau Username
  nama         String
  email        String   @unique
  alamat       String?
  jenisKelamin String
  foto         String?  // URL to profile photo
  isActive     Boolean  @default(true) // Status aktif guru
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  mapel         GuruMapel[]     // Guru bisa mengajar banyak mapel
  kelas         GuruKelas[]     // Guru bisa mengajar di banyak kelas
  waliKelas     Kelas[]         @relation("WaliKelas")
  jadwal        Jadwal[]
  materi        Materi[]
  ujian         Ujian[]
  tugas         Tugas[]
  gradeConfig   GradeConfig?    // Konfigurasi bobot penilaian

  @@index([nipUsername])
  @@index([email])
  @@index([userId])
  @@map("guru")
}

model GuruMapel {
  id      String @id @default(cuid())
  guruId  String
  mapelId String

  guru  Guru          @relation(fields: [guruId], references: [id], onDelete: Cascade)
  mapel MataPelajaran @relation(fields: [mapelId], references: [id], onDelete: Cascade)

  @@unique([guruId, mapelId])
  @@map("guru_mapel")
}

model GuruKelas {
  id      String @id @default(cuid())
  guruId  String
  kelasId String

  guru  Guru  @relation(fields: [guruId], references: [id], onDelete: Cascade)
  kelas Kelas @relation(fields: [kelasId], references: [id], onDelete: Cascade)

  @@unique([guruId, kelasId])
  @@map("guru_kelas")
}

// ============================================
// SISWA
// ============================================

model Siswa {
  id           String   @id @default(cuid())
  userId       String   @unique
  nisn         String   @unique
  nis          String   @unique
  nama         String
  email        String   @unique
  kelasId      String
  jenisKelamin String
  tanggalLahir DateTime
  alamat       String
  noTelp       String?
  namaWali     String
  noTelpWali   String
  foto         String?  // URL to profile photo
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  kelas             Kelas               @relation(fields: [kelasId], references: [id])
  presensi          Presensi[]
  kartuPelajar      KartuPelajar?
  tugasSubmission   TugasSubmission[]
  ujianSubmission   UjianSubmission[]

  @@index([nisn])
  @@index([nis])
  @@index([kelasId])
  @@index([email])
  @@index([userId])
  @@map("siswa")
}

// ============================================
// KARTU PELAJAR
// ============================================

model KartuPelajar {
  id                String   @id @default(cuid())
  siswaId           String   @unique
  tanggalTerbit     DateTime @default(now())
  tanggalKadaluarsa DateTime
  status            String   @default("aktif") // aktif, nonaktif, hilang
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  siswa Siswa @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@map("kartu_pelajar")
}

// ============================================
// JADWAL
// ============================================

model Jadwal {
  id         String   @id @default(cuid())
  kelasId    String
  mapelId    String
  guruId     String
  hari       String // Senin, Selasa, etc
  jamMulai   String // 08:00
  jamSelesai String // 09:30
  ruangan    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  kelas Kelas         @relation(fields: [kelasId], references: [id], onDelete: Cascade)
  mapel MataPelajaran @relation(fields: [mapelId], references: [id], onDelete: Cascade)
  guru  Guru          @relation(fields: [guruId], references: [id], onDelete: Cascade)

  @@map("jadwal")
}

// ============================================
// INFO MASUK & PULANG
// ============================================

model InfoMasuk {
  id        String   @id @default(cuid())
  hari      String   // Senin, Selasa, Rabu, Kamis, Jumat, Sabtu, Minggu
  jamMasuk  String   // 07:00
  jamPulang String   // 14:00
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([hari])
  @@index([hari])
  @@map("info_masuk")
}

// ============================================
// PRESENSI
// ============================================

model Presensi {
  id         String   @id @default(cuid())
  siswaId    String
  tanggal    DateTime @default(now())
  status     String // hadir, izin, sakit, alpha
  keterangan String?
  tipe       String   @default("masuk") // masuk, pulang
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  siswa Siswa @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@unique([siswaId, tanggal, tipe])
  @@index([siswaId])
  @@index([tanggal])
  @@index([status])
  @@index([tipe])
  @@map("presensi")
}

// ============================================
// MATERI PEMBELAJARAN
// ============================================

model Materi {
  id            String   @id @default(cuid())
  judul         String
  deskripsi     String?
  mapelId       String
  guruId        String
  kelas         String[] // Array of kelas names
  tipe          String // pdf, video, image, link
  fileUrl       String?
  ukuran        String?
  tanggalUpload DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  mapel MataPelajaran @relation(fields: [mapelId], references: [id], onDelete: Cascade)
  guru  Guru          @relation(fields: [guruId], references: [id], onDelete: Cascade)

  @@map("materi")
}

// ============================================
// TUGAS
// ============================================

model Tugas {
  id          String   @id @default(cuid())
  judul       String
  deskripsi   String
  instruksi   String
  mapelId     String
  guruId      String
  kelas       String[] // Array of kelas names
  deadline    DateTime
  fileUrl     String?
  status      String   @default("aktif") // aktif, selesai
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  mapel       MataPelajaran     @relation(fields: [mapelId], references: [id], onDelete: Cascade)
  guru        Guru              @relation(fields: [guruId], references: [id], onDelete: Cascade)
  submissions TugasSubmission[]

  @@index([guruId])
  @@index([mapelId])
  @@index([status])
  @@index([deadline])
  @@map("tugas")
}

model TugasSubmission {
  id          String    @id @default(cuid())
  tugasId     String
  siswaId     String
  fileUrl     String?   // URL link (Google Drive, etc) - nullable
  fileUpload  String?   // Uploaded file path - nullable
  catatan     String?
  nilai       Int?
  feedback    String?
  submittedAt DateTime  @default(now())
  gradedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  tugas Tugas @relation(fields: [tugasId], references: [id], onDelete: Cascade)
  siswa Siswa @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@unique([tugasId, siswaId])
  @@index([tugasId])
  @@index([siswaId])
  @@index([submittedAt])
  @@map("tugas_submission")
}

// ============================================
// UJIAN
// ============================================

model Ujian {
  id                String   @id @default(cuid())
  judul             String
  deskripsi         String?
  mapelId           String
  guruId            String
  kelas             String[] // Array of kelas names
  startUjian        DateTime // Waktu mulai ujian (tanggal + jam)
  endUjian          DateTime // Waktu akhir ujian (tanggal + jam)
  shuffleQuestions  Boolean  @default(false)
  showScore         Boolean  @default(true)
  status            String   @default("draft") // draft, aktif, selesai
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  mapel            MataPelajaran      @relation(fields: [mapelId], references: [id], onDelete: Cascade)
  guru             Guru               @relation(fields: [guruId], references: [id], onDelete: Cascade)
  soalPilihanGanda SoalPilihanGanda[]
  soalEssay        SoalEssay[]
  submissions      UjianSubmission[]

  @@index([guruId])
  @@index([mapelId])
  @@index([status])
  @@index([startUjian])
  @@index([endUjian])
  @@map("ujian")
}

// ============================================
// UJIAN ACCESS CONTROL (Admin Only - Global)
// ============================================

model UjianAccessControl {
  id              String    @id @default(cuid())
  isActive        Boolean   @default(false) // Global exam access status
  currentToken    String?   // Current active token (6-digit code)
  tokenGeneratedAt DateTime? // When token was generated
  tokenExpiresAt  DateTime? // Token expires after 2 minutes
  generatedBy     String?   // Admin user ID who generated token
  description     String?   // Optional description for this session
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("ujian_access_control")
}

model SoalPilihanGanda {
  id            String   @id @default(cuid())
  ujianId       String
  pertanyaan    String
  opsiA         String
  opsiB         String
  opsiC         String
  opsiD         String
  jawabanBenar  String // A, B, C, D
  urutan        Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  ujian   Ujian                      @relation(fields: [ujianId], references: [id], onDelete: Cascade)
  jawaban JawabanPilihanGanda[]

  @@map("soal_pilihan_ganda")
}

model SoalEssay {
  id           String   @id @default(cuid())
  ujianId      String
  pertanyaan   String
  kunciJawaban String
  urutan       Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  ujian   Ujian            @relation(fields: [ujianId], references: [id], onDelete: Cascade)
  jawaban JawabanEssay[]

  @@map("soal_essay")
}

model UjianSubmission {
  id          String    @id @default(cuid())
  ujianId     String
  siswaId     String
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  nilai       Int?
  status      String    @default("in_progress") // in_progress, submitted, graded
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  ujian              Ujian                   @relation(fields: [ujianId], references: [id], onDelete: Cascade)
  siswa              Siswa                   @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  jawabanPilihanGanda JawabanPilihanGanda[]
  jawabanEssay       JawabanEssay[]

  @@unique([ujianId, siswaId])
  @@map("ujian_submission")
}

model JawabanPilihanGanda {
  id           String   @id @default(cuid())
  submissionId String
  soalId       String
  jawaban      String // A, B, C, D
  isCorrect    Boolean  @default(false)
  createdAt    DateTime @default(now())

  // Relations
  submission UjianSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  soal       SoalPilihanGanda @relation(fields: [soalId], references: [id], onDelete: Cascade)

  @@unique([submissionId, soalId])
  @@map("jawaban_pilihan_ganda")
}

model JawabanEssay {
  id           String    @id @default(cuid())
  submissionId String
  soalId       String
  jawaban      String
  nilai        Int?
  feedback     String?
  gradedAt     DateTime?
  createdAt    DateTime  @default(now())

  // Relations
  submission UjianSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  soal       SoalEssay        @relation(fields: [soalId], references: [id], onDelete: Cascade)

  @@unique([submissionId, soalId])
  @@map("jawaban_essay")
}

// ============================================
// GRADE CONFIGURATION
// ============================================

model GradeConfig {
  id              String   @id @default(cuid())
  guruId          String   @unique // Satu guru satu konfigurasi
  namaPG          String   @default("Pilihan Ganda") // Nama komponen PG
  bobotPG         Int      @default(50) // Persentase bobot PG (0-100)
  activePG        Boolean  @default(true) // Apakah komponen PG aktif
  namaEssay       String   @default("Essay") // Nama komponen Essay
  bobotEssay      Int      @default(50) // Persentase bobot Essay (0-100)
  activeEssay     Boolean  @default(true) // Apakah komponen Essay aktif
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  guru Guru @relation(fields: [guruId], references: [id], onDelete: Cascade)

  @@index([guruId])
  @@map("grade_config")
}

// ============================================
// NILAI - REMOVED
// ============================================
// Nilai sekarang dihitung langsung dari UjianSubmission
// menggunakan persentase bobot PG & Essay dari GradeConfig
// Tidak perlu tabel terpisah karena nilai = rata-rata semua ujian
